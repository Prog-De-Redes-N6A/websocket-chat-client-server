@page "/"
@using System.Text.Json.Nodes
@using ClientWS.Services
@inject WebSocketService WebSocketService

<PageTitle>Home</PageTitle>

<h1>Hello, world!</h1>
<input @bind="message" placeholder="Escribe un message" />
<button @onclick="SendMessage" disabled="@(!isConnected)">Enviar</button>
<ul>
    @foreach (var msg in messages)
    {
        <li>@msg</li>
    }
</ul>
@if (!isConnected)
{
    <p>Conexion no establecida</p>
}
else
{
    <p>Connected to WebSocket</p>
}


@code {
    private string message = string.Empty;
    private List<JsonObject> messages = new List<JsonObject>();
    private bool isConnected = false;
    
    protected override async Task OnInitializedAsync()
    {
        await WebSocketService.ConnectAsync("ws://localhost:5041/ws");
        isConnected = true;
        StateHasChanged();
        await Task.Run(ReceiveMessages);
    }

    private async Task SendMessage()
    {
        if (string.IsNullOrEmpty(message)) return;
       
        await WebSocketService.SendMessageAsync(message);
        JsonObject payload = new JsonObject
        {
            ["message"] = this.message,
            ["from"] = "Client"
        };
        messages.Add(payload);
    }
    
    private async Task ReceiveMessages()
    {
        while (isConnected)
        {
            try
            {
                var receivedMessage = await WebSocketService.ReceiveMessageAsync();
                JsonObject payload = new JsonObject
                {
                    ["message"] = receivedMessage,
                    ["from"] = "Server"
                };
                messages.Add(payload);
                StateHasChanged();
            }catch (Exception ex)
            {
                Console.WriteLine($"Error receiving message: {ex.Message}");
                isConnected = false;
                StateHasChanged();
            }
            
        }
    }
    
    
    
}